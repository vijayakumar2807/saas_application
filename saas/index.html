<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Client Custom Fields</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input { margin: 5px; padding: 5px; }
    button { margin: 10px 5px; padding: 7px 15px; }
    .field-group { margin-bottom: 10px; }
  </style>
</head>
<body>

  <h2>Client Info</h2>
  <p><strong>Company Name:</strong> <span id="company-name"></span></p>
  <p><strong>Contact Email:</strong> <span id="contact-email"></span></p>
  <p><strong>Industry:</strong> <span id="industry"></span></p>

  <h3>Custom Fields</h3>
  <form id="custom-form">
    <div id="custom-fields-form"></div>
    <button type="button" onclick="addField()">+ Add Field</button>
    <button type="submit">Save</button>
  </form>

  <script>
    const clientId = 4; // Replace with dynamic ID if needed
    const baseUrl = 'http://127.0.0.1:8000'; // Your API base URL

    let client = {};

    const formDiv = document.getElementById("custom-fields-form");

    function renderClientInfo(data) {
      document.getElementById("company-name").textContent = data.company_name || '';
      document.getElementById("contact-email").textContent = data.contact_email || '';
      document.getElementById("industry").textContent = data.industry || '';
    }

    function renderFields(data) {
      formDiv.innerHTML = "";
      Object.entries(data).forEach(([key, value], index) => {
        formDiv.innerHTML += `
          <div class="field-group">
            <input name="key_${index}" value="${key}" placeholder="Field Name" />
            <input name="value_${index}" value="${value}" placeholder="Field Value" />
          </div>`;
      });
    }

    function addField() {
      const index = formDiv.children.length;
      formDiv.innerHTML += `
        <div class="field-group">
          <input name="key_${index}" placeholder="Field Name" />
          <input name="value_${index}" placeholder="Field Value" />
        </div>`;
    }

    document.getElementById("custom-form").addEventListener("submit", function (e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const newData = {};
      for (let [key, value] of formData.entries()) {
        if (key.startsWith("key_")) {
          const index = key.split("_")[1];
          const val = formData.get(`value_${index}`);
          if (value) newData[value] = val;
        }
      }

      fetch(`${baseUrl}/clients/${clientId}/`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ custom_data: newData })
      })
      .then(res => res.json())
      .then(data => {
        alert("Custom fields updated!");
        renderFields(data.custom_data || {});
      })
      .catch(err => {
        alert("Failed to update custom fields.");
        console.error(err);
      });
    });

    function fetchClientData() {
      fetch(`${baseUrl}/clients/${clientId}/`)
        .then(response => response.json())
        .then(data => {
          client = data;
          renderClientInfo(client);
          renderFields(client.custom_data || {});
        })
        .catch(error => {
          alert("Failed to load client data.");
          console.error(error);
        });
    }

    // Load data on page load
    window.onload = fetchClientData;
  </script>
</body>
</html>
